<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>In-situ U-Th-Sm-He calculator</title>
<script src="jquery-1.11.1.js"></script>
<script src="jquery.handsontable.full.js"></script>
<script src="jquery-ui-1.11.0.js"></script>
<link rel="stylesheet" media="screen" href="jquery.handsontable.full.css">
<style>
body {text-align: center; vertical-align: middle;}
div {margin-left: auto; margin-right: auto;}
div.box {border:1px solid black; display:inline-block;}
</style>
</head>
<body>

<script>

var l238 = 0.0001551359; // Ma-1
var l235 = 0.0009845841;
var l232 = 0.00004933431; 
var l147 = 0.0000065268;
var ppm = true;
var precision = 5;
var boyce = false;
var myK, mysK, mySMPs;
var hebox, volbox, standardbox;

$( document ).ready(function() {

$('input[name=boyce]').change(function(){
 boyce = $("input[name='boyce']:checked").val() == "boyce";
 // check to see if elements are in the DOM
 var HeShown = $('#He').length > 0;
 var VolShown = $('#voldens').length > 0;
 var STDshown = $('#standardbox').length > 0;
 if (boyce){
  if (!HeShown){$('#boxes').append(hebox);}
  if (!VolShown){$('#boxes').append(volbox);}
  if (STDshown){standardbox = $('#standardbox').detach();}
 } else {
  if (HeShown){hebox = $('#He').detach();}
  if (VolShown){volbox = $('#voldens').detach();}
  if (!STDshown){$('#standardbox').append(standardbox);}
 }
});

var STDdata = [
["B188-1",523,13,63.1,1.6,1.40,0.11,0.1895,0,1111.9,0,433,10],
["B188-2",503,12,57.2,1.4,1.60,0.13,0.2081,0,1220.8,0,433,10],
["B188-3",493,14,55.6,1.6,1.24,0.11,0.1905,0,1158.5,0,433,10],
["B188-4",545,11,62.0,1.9,1.67,0.14,0.1934,0,1154.3,0,433,10],
["B188-5",549,13,65.7,1.6,1.61,0.14,0.2305,0,1356.3,0,433,10],
["B188-6",536,11,60.9,1.2,1.55,0.14,0.2122,0,1297.6,0,433,10],
["B188-7",547,13,62.3,1.1,1.54,0.13,0.2130,0,1251.4,0,433,10],
["B188-8",542,11,60.9,1.7,1.69,0.14,0.2087,0,1153.3,0,433,10],
["B188-9",541,14,58.8,1.6,1.37,0.13,0.2059,0,1190.5,0,433,10],
["B188-10",585,12,64.6,1.8,1.89,0.15,0.2222,0,1282.4,0,433,10],
["B188-11",521,12,55.7,1.5,1.43,0.10,0.2000,0,1179.0,0,433,10],
["B188-12",547,12,62.9,1.7,1.34,0.13,0.2050,0,1213.1,0,433,10],
["B188-13",565,17,59.1,2.3,1.31,0.12,0.2151,0,1274.6,0,433,10],
["B188-14",566,15,62.9,1.7,1.54,0.10,0.2130,0,1285.7,0,433,10],
["B188-15",562,14,61.7,2.0,1.52,0.11,0.2294,0,1365.2,0,433,10]
];

var SMPdata = [
["RB140-1",302,11,129,5,2.47,0.17,0.1186,0,1341.4,0,,],
["RB140-2",260,10,121,5,2.40,0.17,0.1094,0,1251.7,0,,],
["RB140-3",301,14,123,7,2.61,0.15,0.1198,0,1261.4,0,,],
["RB140-4",262,12,114,4,1.98,0.14,0.1195,0,1278.7,0,,],
["RB140-5",292,13,132,6,2.61,0.17,0.1252,0,1297.9,0,,],
["RB140-6",250,10,113,5,2.21,0.18,0.1180,0,1221.0,0,,],
["RB140-7",295,13,128,5,2.46,0.18,0.1180,0,1241.7,0,,],
["RB140-8",313,14,134,5,2.49,0.18,0.1095,0,1174.1,0,,],
["RB140-9",293,13,132,6,2.35,0.16,0.1085,0,1097.5,0,,],
["RB140-10",297,10,136,6,2.45,0.17,0.1112,0,1202.9,0,,],
["RB140-11",286,11,133,5,2.53,0.17,0.1262,0,1298.8,0,,],
["RB140-12",276,13,111,5,2.61,0.15,0.1259,0,1311.7,0,,],
["RB140-13",301,11,136,6,2.65,0.15,0.1138,0,1173.2,0,,]
];

$('#STDs').handsontable({
  data: STDdata,
  minRows: 50,
  minCols: 13,
  colWidths: [104,60,60,60,60,60,60,60,60,60,60,60,60],
  manualColumnResize: true,
  width: 850,
  height: 300,
  colHeaders: ["name", "U", "&sigma;(U)", "Th", "&sigma;(Th)", "Sm", "&sigma;(Sm)",
               "He", "&sigma;(He)", "vol", "&sigma;(vol)", "age", "&sigma;(age)"],
  contextMenu: true
});

$('#SMPs').handsontable({
  data: SMPdata,
  minRows: 50,
  minCols: 13,
  colWidths: [104,60,60,60,60,60,60,60,60,60,60,60,60],
  manualColumnResize: true,
  width: 850,
  height: 300,
  readOnly: false,
  colHeaders: ["name", "U", "&sigma;(U)", "Th", "&sigma;(Th)", "Sm", "&sigma;(Sm)",
               "He", "&sigma;(He)", "vol", "&sigma;(vol)", "age", "&sigma;(age)"],
  contextMenu: true
});

$('#HELIOTABLE').handsontable({
  minRows: 50,
  minCols: 8,
  colWidths: 103,
  manualColumnResize: true,
  width: 850,
  height: 300,
  colHeaders: ["U", "&sigma;(U)", "Th", "&sigma;(Th)", "Sm", "&sigma;(Sm)", "He", "&sigma;(He)"],
  contextMenu: true
});

$("#run")
 .button()
 .click(function( event ) {
   run();
});

$("#clear")
 .button()
 .click(function( event ) {
  $('#STDs').handsontable('clear');
  $('#SMPs').handsontable('clear');
  $('#HELIOTABLE').handsontable('clear');
});

$("#tohelioplot")
 .button()
 .click(function( event ) {
  $('#HELIOPLOT').css('visibility','visible');
  toHelioplot($('#HELIOTABLE'),mySMPs,myK,mysK);
});

$("#hide")
 .button()
 .click(function( event ) {
  $('#HELIOPLOT').css('visibility','hidden');
});

$("#help")
 .button()
  .click(function( event ) {
   window.location = "help.html";
});

// define Measurements object
function Measurements(jQTable){

 this.data = new Array()

 this.load = function(){
  var numRows = jQTable.handsontable('countRows');
  for (var i=0; i<numRows; i++){
   if (!jQTable.handsontable('isEmptyRow',i)){
    this.data.push(jQTable.handsontable('getDataAtRow',i));
   }
  } 
 }

 this.length = function(){
  return(this.data.length);
 }

 this.getsamplename = function(i){
  return(this.data[i][0]);
 }

 this.U = function(i){
  var out = this.data[i][1];
  if (ppm){out /= 238;} 
  return(out);
 }

 this.sU = function(i){
  var out = this.data[i][2];
  if (ppm){out /= 238;}
  return(out);
 }

 this.Th = function(i){
  var out = this.data[i][3];
  if (ppm){out /= 232;}
  return(out);
 }

 this.sTh = function(i){
  var out = this.data[i][4];
  if (ppm){out /= 232;}
  return(out);
 }

 this.Sm = function(i){
  var out = this.data[i][5];
  if (ppm){out /= 147;}
  return(out);
 }

 this.sSm = function(i){
  var out = this.data[i][6];
  if (ppm){out /= 147;}
  return(out);
 }

 this.He = function(i){
  return(this.data[i][7]);
 }

 this.sHe = function(i){
  return(this.data[i][8]);
 }

 this.Vol = function(i){
  return(this.data[i][9]);
 }

 this.sVol = function(i){
  return(this.data[i][10]);
 }

 this.t = function(i){
  return(this.data[i][11]);
 }

 this.st = function(i){
  return(this.data[i][12]);
 }

}

function a(t){
 return(8*(Math.exp(l238*t)-1)*137.88/138.88 + 7*(Math.exp(l235*t)-1)/138.88);
}

function b(t){
 return(6*(Math.exp(l232*t)-1));
}

function c(t){
 return(0.1499*(Math.exp(l147*t)-1));
}

function getdfdU(t){
 return(8*(Math.exp(l238*t)-1)*137.88/138.88 + 7*(Math.exp(l235*t)-1)/138.88);
}

function getdfdTh(t){
 return(6*(Math.exp(l232*t)-1));
}

function getdfdSm(t){
 return(0.1499*(Math.exp(l147*t)-1));
}

function getdfdK(meas,i){
 return(meas.He(i)/meas.Vol(i));
}

function getdfdHe(meas,i,K){
 return(K/meas.Vol(i));
}

function getd2fdHedK(meas,i){
 return(1/meas.Vol(i));
}

function getdfdV(meas,i,K){
 var V = meas.Vol(i);
 return(K*meas.He(i)/(V*V));
}

function getd2fdVdK(meas,i){
 var V = meas.Vol(i)
 return(meas.He(i)/(V*V));
}

function getdfdt(meas,i,t){
 var out = 8*l238*meas.U(i)*Math.exp(l238*t)*137.88/138.88 + 
           7*l235*meas.U(i)*Math.exp(l235*t)/138.88 + 
           6*l232*meas.Th(i)*Math.exp(l232*t) + 
           0.1499*l147*meas.Sm(i)*Math.exp(l147*t);
 return(out);
}

function getAge(meas,i,K){
 var U = meas.U(i);
 var Th = meas.Th(i);
 var Sm = meas.Sm(i);
 var He = meas.He(i);
 var Vol = meas.Vol(i);
 var P = 8*l238*U*137.88/138.88 + 7*l235*U/138.88 + 6*l232*Th + 0.1499*l147*Sm;
 var lambda =(8*U*l238*l238*137.88/138.88 + 7*U*l235*l235/138.88 + 
              6*Th*l232*l232 + 0.1499*Sm*l147*l147)/P;
 // using the direct solution to the age equation by Meesters and Dunai (2005)
 var out = Math.log(1+lambda*K*He/(Vol*P))/lambda;
 return(out);
}
 
function getAgeErr(meas,i,K,sK,t){
 var dfdU = getdfdU(t),
     dfdTh = getdfdTh(t),
     dfdSm = getdfdSm(t),
     dfdHe = getdfdHe(meas,i,K),
     dfdV = getdfdV(meas,i,K),
     dfdK = getdfdK(meas,i),
     dfdt = getdfdt(meas,i,t),
     sU = meas.sU(i),
     sTh = meas.sTh(i),
     sSm = meas.sSm(i),
     sHe = meas.sHe(i),
     sV = meas.sVol(i),
     vt = (dfdU*dfdU*sU*sU + dfdTh*dfdTh*sTh*sTh + dfdSm*dfdSm*sSm*sSm + 
            dfdHe*dfdHe*sHe*sHe + dfdV*dfdV*sV*sV + dfdK*dfdK*sK*sK)/(dfdt*dfdt);
 return(Math.sqrt(vt));
}

function getShati2(meas,i,K){
 var t = meas.t(i),
     dfdU = getdfdU(t),
     dfdTh = getdfdTh(t),
     dfdSm = getdfdSm(t),
     dfdHe = getdfdHe(meas,i,K),
     dfdV = getdfdV(meas,i,K),
     dfdt = getdfdt(meas,i,t),
     sU = meas.sU(i),
     sTh = meas.sTh(i),
     sSm = meas.sSm(i),
     sHe = meas.sHe(i),
     sV = meas.sVol(i),
     out = (dfdU*dfdU*sU*sU + dfdTh*dfdTh*sTh*sTh + dfdSm*dfdSm*sSm*sSm + 
            dfdHe*dfdHe*sHe*sHe + dfdV*dfdV*sV*sV)/(dfdt*dfdt);
     return(out);
}

// define 'Standards' object
function STDs(measurements){

 this.meas = measurements;

 this.getHe = function(i){
  var t = this.meas.t(i);
  return (a(t)*this.meas.U(i) + b(t)*this.meas.Th(i) + c(t)*this.meas.Sm(i));
 }

 this.initialK = function(){
  var n = this.meas.data.length, out = 0;
  // calculate mean
  for (var i=0; i<n; i++){
   out += this.meas.Vol(i)*this.getHe(i)/(n*this.meas.He(i));
  }
  return(out);
 }

 // d-th derivative of the log-likelihood function
 this.getdL = function(K,d){
  var n = this.meas.data.length, 
      out = 0, t, thati, si, shati2, 
      dfdK, dfdV, dfdHe, d2fdVdK, d2fdHedK, 
      dfdt, sV, sHe, N, P, Np, Dp;
  for (var i=0; i<n; i++){
   t = this.meas.t(i);
   thati = getAge(this.meas,i,K);
   si = this.meas.st(i);
   shati2 = getShati2(this.meas,i,K);
   N = (t-thati)*(t-thati);
   D = si*si + shati2;
   if (d==0){ // return likelihood
    out += N/D;
   } else {
    dfdK = getdfdK(this.meas,i);
    dfdV = getdfdV(this.meas,i,K);
    dfdHe = getdfdHe(this.meas,i,K);
    dfdt = getdfdt(this.meas,i,t);
    d2fdVdK = getd2fdVdK(this.meas,i);
    d2fdHedK = getd2fdHedK(this.meas,i);
    sV = this.meas.sVol(i);
    sHe = this.meas.sHe(i);
    Np = -2*(t-thati)*dfdK/dfdt;
    Dp = 2*(dfdV*d2fdVdK*sV*sV + dfdHe*d2fdHedK*sHe*sHe)/(dfdt*dfdt);
    if (d==1){ // first derivative
     out += (Np*D-N*Dp)/(D*D);
    } else { // second derivative
     Np2 = -2*(dfdK*dfdK)/(dfdt*dfdt);
     Dp2 = 2*(d2fdVdK*d2fdVdK*sV*sV + d2fdHedK*d2fdHedK*sHe*sHe)/(dfdt*dfdt);
     out += (Np2*D*D - N*D*Dp2 - 2*Np*D*Dp + 2*N*Dp*Dp)/(D*D*D);
    }
   }
   return(out);
  }
 }

 // uses Newton's method to find K
 this.getK = function(){
  var K = this.initialK();
  for (var i=0; i<10; i++){
   K += this.getdL(K,1)/this.getdL(K,2);
  }
  return(K);
 }

 // calculate Kappa uncertainty with Fisher Information
 this.getKerr = function(K){
  return(Math.sqrt(-1/this.getdL(K,2)));
 }

}

// define 'Samples' object
function SMPs(measurements){

 this.meas = measurements;

 this.getAge = function(i,K){
  return(getAge(this.meas,i,K));
 }

 this.getAgeErr = function(i,K,sK,t){
  return(getAgeErr(this.meas,i,K,sK,t));
 }

}

function setAges(jQTable,mySMPs,K,sK){
 var n = mySMPs.meas.data.length;
 var t = 0, st = 0;
 for (var i=0; i<n; i++){
  t = mySMPs.getAge(i,K);
  st = mySMPs.getAgeErr(i,K,sK,t);
  jQTable.handsontable('setDataAtCell',i,11,t.toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,12,st.toPrecision(precision));
 }
}

function toHelioplot(jQTable,mySMPs,K,sK){
 var m = mySMPs.meas;
 var n = m.data.length;
 var He, sHe, V, sV;
 for (var i=0; i<n; i++){
  jQTable.handsontable('setDataAtCell',i,0,m.U(i).toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,1,m.sU(i).toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,2,m.Th(i).toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,3,m.sTh(i).toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,4,m.Sm(i).toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,5,m.sSm(i).toPrecision(precision));
  He = m.He(i); sHe = m.sHe(i);
  V = m.Vol(i); sV = m.sVol(i);
  sHe = (K*He/V)*Math.sqrt((sHe*sHe)/(He*He) + (sK*sK)/(K*K) + (sV*sV)/(V*V));
  He = K*He/V;
  jQTable.handsontable('setDataAtCell',i,6,He.toPrecision(precision));
  jQTable.handsontable('setDataAtCell',i,7,sHe.toPrecision(precision));
 }
}

function run(){
 ppm = $("input[name='ppmfmol']:checked").val() == "ppm";
 var mySTDs = new STDs(new Measurements($('#STDs')));
 mySTDs.meas.load();
 mySMPs = new SMPs(new Measurements($('#SMPs')));
 mySMPs.meas.load();
 myK = mySTDs.getK(); // global variable, can be used by toHelioplot function!
 mysK = mySTDs.getKerr(myK);
 setAges($('#SMPs'),mySMPs,myK,mysK);
}

standardbox = $('#standardbox');
hebox = $('#He');
volbox = $('#voldens');
$("input:radio[name='boyce']").click();

});
</script>

<form>
<div id="boxes">
<div class="box" id="boycevermeesch">
&nbsp;  <input type="radio" name="boyce" value="boyce"> first principles
 <input type="radio" name="boyce" value="vermeesch"> pairwise &nbsp;
</div>
<div class="box" id="UThSm">
 &nbsp; U, Th, Sm in
 <input type="radio" name="ppmfmol" value="ppm" checked="true"> ppm
 <input type="radio" name="ppmfmol" value="fmol"> fmol/g &nbsp;
</div>
<div class="box" id="He">
 &nbsp; He in 
 <input type="radio" name="nccfmol" value="ncc" checked="true"> ncc
 <input type="radio" name="nccfmol" value="fmol"> fmol &nbsp;
</div>
<div class="box" id="voldens">
&nbsp; vol in &mu;m<sup>3</sup>, &rho; = <input type="text" name="rho" value="3.5" 
style="width:50px;"> g/cm<sup>3</sup> &nbsp;
</div>
</div>
</form>
<p></p>
<div id="standardbox">
Standards:
<p></p>
<div id="STDs" style="overflow: auto"></div>
</div>
<p></p>
<div id="samplebox">
Samples:
<p></p>
<div id="SMPs" style="overflow: auto"></div>
</div>
<p></p>
<button id="run"><b>RUN</b></button>
<button id="clear">CLEAR</button>
<button id="help">HELP</button>
<button id="tohelioplot">TO HELIOPLOT</button>
<div id="HELIOPLOT" style="overflow: auto; visibility: hidden;">
<p></p>
Input file for <a href="http://helioplot.london-geochron.com">HelioPlot</a>:
<p></p>
<div id="HELIOTABLE"></div>
<p></p>
<button id="hide">HIDE</button>
</div>
</body>
</html>
